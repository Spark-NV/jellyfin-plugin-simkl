<!DOCTYPE html>
<html>
<head>
    <title>Simkl's TV Tracker</title>
</head>
<body>
<div data-role="page" class="page type-interior pluginConfigurationPage" id="SimklConfigurationPage"
     data-require="emby-button,emby-checkbox,emby-input,emby-select">
    <div data-role="content">
        <div class="content-primary">
            <h1>Simkl's TV Tracker</h1>
            <form id="SimklConfigurationForm">
                <div id="loginButtonContainer" hidden>
                    <h3>It seems you are not logged in, do you wish to log in?</h3>
                    <button onclick="SimklConfig.startLoginProcess();" is="emby-button" type="button"
                            class="raised button-submit block"><span>Log In</span></button>
                    <button onclick="location.href='https://simkl.com/';" is="emby-button" type="button"
                            class="raised block"><span>Create an account</span></button>
                </div>
                <div id="loggingIn" hidden>
                    <h2>Logging In</h2>
                    <div id="loginText"></div>
                    <h3 id="loginPin"></h3>
                    <span id="loginSecondsRemaining">900</span> seconds remaining
                    <button onclick="SimklConfig.stopLoginProcess();" is="emby-button" type="button"
                            class="raised button-cancel block"><span>Cancel</span></button>
                </div>
                <div id="configOptionsContainer" hidden>
                    <h3>Hello again <span id="simklName">USERNAME</span>!</h3>
                    <button onclick="SimklConfig.logOut();" is="emby-button" type="button" class="raised button block">
                        <span>Log Out</span></button>
                    <h2>Simkl List Import:</h2>
                    <div class="inputContainer">
                        <select is="emby-select" id="ImportListStatus" label="Import from List:">
                            <option value="plantowatch">Plan to Watch</option>
                            <option value="watching">Currently Watching</option>
                            <option value="completed">Completed</option>
                            <option value="hold">On Hold</option>
                            <option value="dropped">Dropped</option>
                        </select>
                        <div class="fieldDescription">
                            Select which Simkl list to import from
                        </div>
                    </div>
                    <div class="inputContainer">
                        <select is="emby-select" id="MoviesLibraryId" label="Movies Library:">
                            <option value="">-- Select Library --</option>
                        </select>
                        <div class="fieldDescription">
                            Select library where movie folders will be created
                        </div>
                    </div>
                    <div class="inputContainer">
                        <select is="emby-select" id="TvShowsLibraryId" label="TV Shows Library:">
                            <option value="">-- Select Library --</option>
                        </select>
                        <div class="fieldDescription">
                            Select library where TV show folders will be created
                        </div>
                    </div>
                    <div class="inputContainer">
                        <select is="emby-select" id="AnimeLibraryId" label="Anime Library:">
                            <option value="">-- Select Library --</option>
                        </select>
                        <div class="fieldDescription">
                            Select library where anime TV show folders will be created
                        </div>
                    </div>
                    <div class="inputContainer">
                        <select is="emby-select" id="AnimeMoviesLibraryId" label="Anime Movies Library:">
                            <option value="">-- Select Library --</option>
                        </select>
                        <div class="fieldDescription">
                            Select library where anime movie folders will be created
                        </div>
                    </div>
                    <div class="inputContainer">
                        <label class="checkboxContainer">
                            <input is="emby-checkbox" id="TriggerLibraryScanAfterImport" type="checkbox"/>
                            <span>Trigger library scan after import</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, a library scan will be triggered after importing lists. Disable for testing without triggering library updates.
                        </div>
                    </div>
                    <button onclick="SimklConfig.importPlanToWatch();" is="emby-button" type="button"
                            class="raised button-submit block">
                        <span>Import Selected List</span>
                    </button>
                    <div id="importStatus" style="margin-top: 10px;"></div>
                    <button is="emby-button" type="submit" class="raised button-submit block"><span>${Save}</span>
                    </button>
                    <button is="emby-button" type="button" class="raised block" onclick="history.back();"><span>${Cancel}</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script type="text/javascript">
        var SimklConfig = {
            guid: "ce05df96-ddc3-43a2-915c-536f1ad61556",
            onLoginProcess: false,
            configCache: [],
            loginTimer: null,
            remainingTimer: null,
            finish: null,

            loginButtonContainer: document.querySelector('#loginButtonContainer'),
            configOptionsContainer: document.querySelector('#configOptionsContainer'),
            simklName: document.querySelector('#simklName'),
            loginSecondsRemaining: document.querySelector('#loginSecondsRemaining'),
            loginText: document.querySelector('#loginText'),
            loginPin: document.querySelector('#loginPin'),
            loggingIn: document.querySelector('#loggingIn'),

            populateLibraries: async function () {
                try {
                    const request = {
                        url: window.ApiClient.getUrl('Simkl/libraries'),
                        type: 'GET',
                        headers: {
                            accept: 'application/json'
                        }
                    };

                    const libraries = await window.ApiClient.fetch(request);
                    const moviesSelect = document.querySelector('#MoviesLibraryId');
                    const tvShowsSelect = document.querySelector('#TvShowsLibraryId');
                    const animeSelect = document.querySelector('#AnimeLibraryId');
                    const animeMoviesSelect = document.querySelector('#AnimeMoviesLibraryId');

                    if (moviesSelect && tvShowsSelect && animeSelect && animeMoviesSelect) {
                        // Clear existing options except the first one
                        while (moviesSelect.options.length > 1) {
                            moviesSelect.remove(1);
                        }
                        while (tvShowsSelect.options.length > 1) {
                            tvShowsSelect.remove(1);
                        }
                        while (animeSelect.options.length > 1) {
                            animeSelect.remove(1);
                        }
                        while (animeMoviesSelect.options.length > 1) {
                            animeMoviesSelect.remove(1);
                        }

                        // Populate dropdowns
                        libraries.forEach(function (library) {
                            const option = new Option(library.Name, library.Id);
                            moviesSelect.append(option.cloneNode(true));
                            tvShowsSelect.append(option.cloneNode(true));
                            animeSelect.append(option.cloneNode(true));
                            animeMoviesSelect.append(option);
                        });
                    }
                } catch (error) {
                    console.error("Error fetching libraries:", error);
                }
            },
            loadConfig: async function (config) {
                if (config != null) {
                    this.configCache = config;
                } else {
                    config = this.configCache;
                }

                // Ensure config structure exists
                if (!config) {
                    config = {};
                    this.configCache = config;
                }

                console.log("Simkl: Loading global config");
                console.log(config);

                SimklConfig.loginButtonContainer.setAttribute('hidden', '');
                SimklConfig.configOptionsContainer.setAttribute('hidden', '');

                if (config.UserToken != null && config.UserToken !== "") {
                    SimklConfig.configOptionsContainer.removeAttribute('hidden');
                    await this.populateOptionsContainer(config);
                } else {
                    SimklConfig.loginButtonContainer.removeAttribute('hidden');
                }
            },
            saveConfig: async function () {
                // Ensure configCache exists
                if (!this.configCache) {
                    this.configCache = {};
                }

                // Update config from form elements
                for (const key in this.configCache) {
                    if (key === 'UserToken') continue; // Don't overwrite token from form
                    const element = document.querySelector("#configOptionsContainer #" + key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            this.configCache[key] = element.checked;
                        } else {
                            if (element.value != null) {
                                this.configCache[key] = element.value;
                            }
                        }
                    }
                }

                // Handle specific form elements
                const importListStatusInput = document.querySelector("#configOptionsContainer #ImportListStatus");
                if (importListStatusInput) {
                    this.configCache.ImportListStatus = importListStatusInput.value || "plantowatch";
                }

                const moviesLibrarySelect = document.querySelector("#configOptionsContainer #MoviesLibraryId");
                if (moviesLibrarySelect) {
                    this.configCache.MoviesLibraryId = moviesLibrarySelect.value || "";
                }

                const tvShowsLibrarySelect = document.querySelector("#configOptionsContainer #TvShowsLibraryId");
                if (tvShowsLibrarySelect) {
                    this.configCache.TvShowsLibraryId = tvShowsLibrarySelect.value || "";
                }

                const animeLibrarySelect = document.querySelector("#configOptionsContainer #AnimeLibraryId");
                if (animeLibrarySelect) {
                    this.configCache.AnimeLibraryId = animeLibrarySelect.value || "";
                }

                const animeMoviesLibrarySelect = document.querySelector("#configOptionsContainer #AnimeMoviesLibraryId");
                if (animeMoviesLibrarySelect) {
                    this.configCache.AnimeMoviesLibraryId = animeMoviesLibrarySelect.value || "";
                }


                const triggerLibraryScanInput = document.querySelector("#configOptionsContainer #TriggerLibraryScanAfterImport");
                if (triggerLibraryScanInput) {
                    this.configCache.TriggerLibraryScanAfterImport = triggerLibraryScanInput.checked;
                }

                console.log("Saving config:");
                console.log(this.configCache);
                
                try {
                    await ApiClient.updatePluginConfiguration(this.guid, this.configCache);
                    // Refresh config cache from server after successful save
                    const updatedConfig = await ApiClient.getPluginConfiguration(this.guid);
                    if (updatedConfig) {
                        this.configCache = updatedConfig;
                    }
                    Dashboard.processPluginConfigurationUpdateResult();
                } catch (error) {
                    console.error("Error saving configuration:", error);
                    Dashboard.alert("Failed to save configuration. Please try again.");
                }
            },
            populateOptionsContainer: async function (config) {
                try {
                    const userSettings = await SimklAPI.getUserSettings(config.UserToken);
                    if (userSettings && userSettings.user) {
                        SimklConfig.simklName.innerText = userSettings.user.name;
                    }
                } catch (error) {
                    console.error("Error fetching user settings:", error);
                    SimklConfig.simklName.innerText = "User";
                }

                for (const key in config) {
                    const chk = document.querySelector("#configOptionsContainer input[type=checkbox]#" + key);
                    if (chk) {
                        chk.checked = config[key];
                    }


                    const input = document.querySelector("#configOptionsContainer input[type=number]#" + key);
                    if (input) {
                        input.value = config[key];
                    }

                    const textInput = document.querySelector("#configOptionsContainer input[type=text]#" + key);
                    if (textInput) {
                        textInput.value = config[key] || "";
                    }


                    const selectInput = document.querySelector("#configOptionsContainer select#" + key);
                    if (selectInput) {
                        const value = config[key];
                        // Handle Guid values - they come as strings from JSON
                        if (value != null) {
                            const stringValue = typeof value === 'string' ? value : (value.toString ? value.toString() : '');
                            // Only set if it's a valid non-empty Guid
                            if (stringValue && stringValue !== '' && stringValue !== '00000000-0000-0000-0000-000000000000') {
                                selectInput.value = stringValue;
                            } else {
                                selectInput.value = '';
                            }
                        }
                    }
                }
            },
            startLoginProcess: async function () {
                this.onLoginProcess = true;

                const code = await SimklAPI.getCode();
                this.finish = new Date();
                this.finish.setSeconds(this.finish.getSeconds() + code.expires_in);
                this.nextInterval = new Date();

                this.loginTimer = window.setTimeout(this.checkLoginProcess.bind(this, code), code.Interval * 1000);
                this.remainingTimer = window.setInterval(function () {
                    SimklConfig.loginSecondsRemaining.innerText = Math.round((SimklConfig.finish.getTime() - (new Date().getTime())) / 1000);
                }, 1000);

                SimklConfig.loginText.innerHTML = 'Please visit <a href="' + code.verification_url + '/' + code.user_code + '" target="_blank">' + code.verification_url + '</a> on your phone or compouter and enter the following code:';

                SimklConfig.loginPin.innerText = code.user_code;

                SimklConfig.loginButtonContainer.setAttribute('hidden', '');
                SimklConfig.loggingIn.removeAttribute('hidden');
            },
            checkLoginProcess: async function (code) {
                const response = await SimklAPI.checkCode(code.user_code);
                console.log("Response:");
                console.log(response);

                if (new Date() > this.finish) {
                    Dashboard.alert("Timed out!");
                    await this.stopLoginProcess();
                } else if (response.result === "KO") {
                    this.loginTimer = window.setTimeout(this.checkLoginProcess.bind(this, code), code.Interval * 1000);
                } else if (response.result === "OK") {
                    await this.stopLoginProcess();

                    // Ensure configCache structure exists
                    if (!this.configCache) {
                        this.configCache = {};
                    }
                    
                    // Save token to global config
                    this.configCache.UserToken = response.access_token;

                    console.log(this.configCache);

                    await ApiClient.updatePluginConfiguration(this.guid, this.configCache);
                    await this.loadConfig();
                } else {
                    Dashboard.alert("Error logging in");
                }
            },
            stopLoginProcess: async function () {
                this.onLoginProcess = false;
                window.clearTimeout(this.loginTimer);
                window.clearInterval(this.remainingTimer);
                SimklConfig.loginButtonContainer.removeAttribute('hidden');
                SimklConfig.loggingIn.setAttribute('hidden', '');
            },
            logOut: function () {
                // Ensure configCache structure exists
                if (!this.configCache) {
                    this.configCache = {};
                }

                // Clear token from global config
                this.configCache.UserToken = "";

                console.log("Logging out");
                console.log(this.configCache);
                window.ApiClient.updatePluginConfiguration(this.guid, this.configCache);
                this.loadConfig();
            },
            importPlanToWatch: async function () {
                const statusDiv = document.querySelector('#importStatus');
                const listStatusSelect = document.querySelector('#ImportListStatus');
                const listStatusName = listStatusSelect ? listStatusSelect.options[listStatusSelect.selectedIndex].text : "list";
                statusDiv.innerHTML = `Importing ${listStatusName}...`;
                statusDiv.style.color = "blue";

                try {
                    const request = {
                        url: window.ApiClient.getUrl('Simkl/import/plan-to-watch'),
                        type: 'POST',
                        headers: {
                            accept: 'application/json'
                        }
                    };

                    const result = await window.ApiClient.fetch(request);
                    
                    if (result.Success) {
                        let message = "Import completed successfully!<br/>";
                        if (result.MoviesCreated > 0) {
                            message += `Created ${result.MoviesCreated} movie folder(s). `;
                            if (result.MoviesFilesCopied > 0) {
                                message += `Copied ${result.MoviesFilesCopied} stub file(s). `;
                            }
                        }
                        if (result.ShowsCreated > 0) {
                            message += `Created ${result.ShowsCreated} TV show folder(s). `;
                        }
                        if (result.AnimeCreated > 0) {
                            message += `Created ${result.AnimeCreated} anime TV show folder(s). `;
                        }
                        if (result.AnimeMoviesCreated > 0) {
                            message += `Created ${result.AnimeMoviesCreated} anime movie folder(s). `;
                        }
                        if (result.MoviesErrors > 0 || result.ShowsErrors > 0 || result.AnimeErrors > 0 || result.AnimeMoviesErrors > 0) {
                            message += `<br/>Errors: ${result.MoviesErrors} movie errors, ${result.ShowsErrors} TV show errors, ${result.AnimeErrors} anime TV errors, ${result.AnimeMoviesErrors} anime movie errors.`;
                        }
                        statusDiv.innerHTML = message;
                        statusDiv.style.color = "green";
                    } else {
                        statusDiv.innerHTML = "Import failed: " + (result.Error || "Unknown error");
                        statusDiv.style.color = "red";
                    }
                } catch (error) {
                    console.error("Import error:", error);
                    statusDiv.innerHTML = "Import failed. See browser console for details.";
                    statusDiv.style.color = "red";
                }
            }
        }

        var SimklAPI = {
            getCode: function () {
                const request = {
                    url: window.ApiClient.getUrl('Simkl/oauth/pin'),
                    type: 'GET',
                    headers: {
                        accept: 'application/json'
                    }
                }

                return window.ApiClient.fetch(request)
                    .then(function (result) {
                        return result;
                    })
                    .catch(function (result) {
                        console.error(result);
                        Dashboard.alert("Some error occurred, see browser log for more details");
                        SimklConfig.stopLoginProcess();
                    });
            },
            checkCode: function (user_code) {
                const request = {
                    url: window.ApiClient.getUrl('Simkl/oauth/pin/' + user_code),
                    type: 'GET',
                    headers: {
                        accept: 'application/json'
                    }
                }

                return window.ApiClient.fetch(request)
                    .then(function (result) {
                        return result;
                    })
                    .catch(function (result) {
                        console.error(result);
                        Dashboard.alert("Some error occurred, see browser log for more details");
                        SimklConfig.stopLoginProcess();
                    });
            },
            getUserSettings: function (userToken) {
                const request = {
                    url: window.ApiClient.getUrl('Simkl/users/settings'),
                    type: 'GET',
                    headers: {
                        accept: 'application/json'
                    }
                }

                return window.ApiClient.fetch(request)
                    .then(function (result) {
                        return result;
                    })
                    .catch(function (result) {
                        console.error(result);
                        Dashboard.alert("Something went wrong, see logs for more details");
                    });
            }
        }

        document.querySelector('#SimklConfigurationPage')
            .addEventListener('pageshow', async function () {
                Dashboard.showLoadingMsg();
                await Promise.all([
                    SimklConfig.populateLibraries(),
                    window.ApiClient.getPluginConfiguration(SimklConfig.guid).then(SimklConfig.loadConfig.bind(SimklConfig))]);
                Dashboard.hideLoadingMsg();
            });

        document.querySelector('#SimklConfigurationForm')
            .addEventListener('submit', function (e) {
                e.preventDefault();

                Dashboard.showLoadingMsg();
                SimklConfig.saveConfig();
                Dashboard.hideLoadingMsg();
            });
    </script>
</div>
</body>
</html>

